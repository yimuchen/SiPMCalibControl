<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SiPM Calibration Control Program: Installation instructions</title>
<!-- Overriding the tabs css with our own -->
<!--link href="tabs.css" rel="stylesheet" type="text/css"/-->
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--Explicitly calling the including the stuff required for search-->
<!--<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
-->
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" />
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SiPM Calibration Control Program
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Installation instructions</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Installing the Calibration Control programs</h2>
<p>This is the program that is maintained by this packages by the developers at the University of Maryland. Installation should be done on the machine that is capable of interfacing with both the readout system and the trigger system. Current installation requirements include:</p>
<ul>
<li>Software libraries<ul>
<li>C++ compiler compatible with C++14 standard (using g++ as default)</li>
<li><a href="https://opencv.org/releases/">OpenCV 4</a>: For visual processing routines (webcams that can be used in the system generally does not require special driver systems)</li>
<li><a href="https://cmake.org/download/">CMake 3</a>: For handling the build environemtn</li>
<li><a href="https://pybind11.readthedocs.io/en/stable/">pybind11</a>: For generating python binding for code written in C++</li>
<li>Python 3: Main language used for high-level interface design.<ul>
<li><a href="https://numpy.org/">numpy</a> and <a href="https://www.scipy.org/scipylib/index.html">scipy</a>: For in-time data processing.</li>
<li><a href="https://flask-socketio.readthedocs.io/en/latest/">flask socketio</a>: For GUI server hosting.</li>
<li><a href="http://www.paramiko.org/">paramiko</a>: For interaction of machines over network connections, required for the tileboard controller system controls, as well as sending the calibration outputs to remote servers for detailed data processing.</li>
<li><a href="https://pyzmq.readthedocs.io/en/latest/">zmq</a>: For interacting with the tileboard controller server instances.</li>
<li><a href="https://pyyaml.org/wiki/PyYAMLDocumentation">yaml</a>: For interacting with the tileboard controller configurations.</li>
<li><a href="https://uproot.readthedocs.io/en/latest/">uproot</a>: For processing the data returned by the tileboard controller.</li>
</ul>
</li>
</ul>
</li>
<li>Hardware specific tools:<ul>
<li><a href="https://www.picotech.com/downloads/linux">libps5000</a>: For interfacing with the Picoscope oscilloscope for data readout.</li>
<li><a href="https://www.psi.ch/en/drs/software-download">drs</a>: For interfacing with the readout DRS oscilloscope for data readout.</li>
</ul>
</li>
<li>For web interface generation<ul>
<li><a href="https://sass-lang.com/install">dart-sass</a> for <code>css</code> file generation.</li>
</ul>
</li>
</ul>
<p>The current configuration is designed to work on a <a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b-plus/">Raspberry Pi 3B+</a> running <a href="https://archlinuxarm.org/about/downloads">Arch Linux ARM7</a>, and is known to work with a typical Arch Linux machine for local testing. Equivalent packages for different Linux distribution should also work, but have not been exhaustively tested. Notice, that this system is intended to work with some ARM-based headless system. As network configurations should not be stored online, contact the system maintainers if you have issues connecting to the system.</p>
<h3>Arch Linux ARM for Deployment</h3>
<h4>Dependency installation</h4>
<p>First, we can set up to code repository you can clone the main repository by cloning the git repository:</p>
<div class="fragment"><div class="line">git clone https://github.com/UMDCMS/SiPMCalibControl.git</div>
<div class="line">cd SiPMCalibControl</div>
</div><!-- fragment --><p>But do not attempt to compile or run the program just yet, as additional dependencies need to be installed. Other than the standard developer packages such as a C++ compiler and make, there are additional packages that need to be installed via the <code>pacman</code> command for ArchLinux.</p>
<div class="fragment"><div class="line"># For ssh tunneling for the CLI interface</div>
<div class="line">pacman -Sy --noconfirm xorg-xauth</div>
<div class="line"> </div>
<div class="line"># The main C++ libraries and building</div>
<div class="line">pacman -Sy --noconfirm cmake opencv pybind11 fmt</div>
<div class="line"> </div>
<div class="line"># For additional package management</div>
<div class="line">pacman -Sy --noconfirm git</div>
<div class="line"> </div>
<div class="line">## The main python packages</div>
<div class="line">pacman -Sy --noconfirm python-scipy          \</div>
<div class="line">                       python-opencv         \</div>
<div class="line">                       python-psutil         \</div>
<div class="line">                       python-paramiko       \</div>
<div class="line">                       python-flask-socketio \</div>
<div class="line">                       python-pyzmq          \</div>
<div class="line">                       python-yaml           \</div>
<div class="line">                       python-tqdm           \</div>
<div class="line">                       python-uproot</div>
<div class="line"> </div>
<div class="line">## Additional packages required for opencv, since we are using the high level interface</div>
<div class="line">pacman -Sy --noconfirm qt5-base hdf5-openmpi vtk glew</div>
</div><!-- fragment --><p>Let the package developers know if you run into any issues with any of the install commands.</p>
<h4>Hardware specific dependency installation</h4>
<p>Not all interfaces are required for the package compile to complete. Which is useful when testing on personal hardware where one might not want to install the exotic hardware drivers. External package will be pulled to the <code>/external</code> directory of the directory.</p>
<h5>Picoscope</h5>
<p>The picoscope is a testing readout solution used during the calibration system development. This is not going to be added to the final deployment model, but should still be used for testing purposes. You can find the correct version <a href="https://labs.picotech.com/debian/pool/main/libp/libps5000/">here</a>. The following are instruction for added the required instruction for adding the picoscope to the external directory to be installed.</p>
<div class="fragment"><div class="line">cd external</div>
<div class="line">wget https://labs.picotech.com/debian/pool/main/libp/libps5000/libps5000_version.deb</div>
<div class="line">ar x libps5000_version.deb</div>
<div class="line"> </div>
<div class="line">tar xvf data.tar.xz</div>
<div class="line">mv opt/picoscope ./</div>
<div class="line"> </div>
<div class="line">## Clean up stray files</div>
<div class="line">rm control.tar.gz</div>
<div class="line">rm debian-binary</div>
<div class="line">rm usr/ -rf</div>
<div class="line">rm opt/ -rf</div>
</div><!-- fragment --><h5>DRS4</h5>
<p>The DRS4 is the high resolution readout used for the calibration system development. This is not going to be added for the final deployment model, but should still be compilable for testing purposes. You can find the correct version on the DRS <a href="https://www.psi.ch/en/drs/software-download">software page</a>. The following are instructions for adding the DRS 4 package to the external directory:</p>
<div class="fragment"><div class="line">cd external</div>
<div class="line">wget https://www.psi.ch/sites/default/files/import/drs/SoftwareDownloadEN/drs-5.0.5.tar.gz</div>
<div class="line"> </div>
<div class="line">tar zxvf drs-5.0.5.tar.gz</div>
<div class="line">mv drs-5.0.5 drs</div>
</div><!-- fragment --><h4>Interface permission</h4>
<p>First ensure that the <code>i2c</code> interface and the <code>pwm</code> interface has been enabled on the device. For a Raspberry Pi, add the following lines in to the <code>/boot/config.txt</code> file. Notice if you are using this for local interface testing, <b>be very careful</b> with the permissions as the <code>i2c</code> and <code>pwm</code> may be used other systems in the machine (ex: For the air flow fans). Do <em>NOT</em> enable these permissions on your personal machine unless you are sure about what the permissions would affect. Note that the <code>dtparam</code> line must added after the kernel loading line.</p>
<div class="fragment"><div class="line">dtoverlay=pwm-2chan</div>
<div class="line">dtparam=i2c_arm=on</div>
</div><!-- fragment --><p>Next, change the permission of various devices to avoid running the program as root. For the GPIO/I2C and picoscope interface, create new groups indicating the usage and add your user to it:</p>
<div class="fragment"><div class="line">groupadd -f -r gpio</div>
<div class="line">usermod -a -G gpio ${USER}</div>
<div class="line">groupadd -f -r i2c</div>
<div class="line">usermod -a -G i2c ${USER}</div>
<div class="line">groupadd -f -r pico</div>
<div class="line">usermod -a -G pico ${USER}</div>
<div class="line">groupadd -f -r drs</div>
<div class="line">usermod -a -G drs ${USER}</div>
</div><!-- fragment --><p>Then create a <code>udev</code> rule to change the permission of the relevant hardware. Copy the provided rules file to the <code>/etc/udev/rules.d</code> directory. A reboot is required for the results to take effect.</p>
<div class="fragment"><div class="line">cp external/rules/pico.rules  /etc/udev/rules/</div>
<div class="line">cp external/rules/drs.rules   /etc/udev/rules/</div>
<div class="line">cp external/rules/digi.rules  /etc/udev/rules/</div>
</div><!-- fragment --><p>If you are running the control software on your laptop, do <b>NOT</b> copy the <code>digi.rules</code> file to you laptop unless you know what you are doing. Adjustments to the hardware permission on typical machines can result in system instability and potential hardware damage.</p>
<h3>Compiling the control program</h3>
<p>The package makes use of the CMake package to run the installation.</p>
<div class="fragment"><div class="line">git clone https://github.com/yimuchen/SiPMCalibControl.git</div>
<div class="line">cd SiPMCalibControl</div>
<div class="line"> </div>
<div class="line">cmake ./</div>
<div class="line">cmake --build ./</div>
<div class="line"> </div>
<div class="line">python3 control.py     # For interactive CLI interface</div>
<div class="line">python3 gui_control.py # For starting GUI server</div>
</div><!-- fragment --><h3>Deployment in non-standard systems for development and debugging</h3>
<p>Installation instructions above works for x86 Arch Linux installations, and such work for all UNIX based systems assuming all the dependencies are satisfied. See the sections above to see the dependencies. In addition, we provide a docker image for people looking to develop locally in a non-standard environment.</p>
<h4>Docker instructions</h4>
<p>This is mainly used for testing interface development. While the docker script will copy the hardware interface packages for compilation, the interactive interface is set up such that it will still operate if the various control components are not available.</p>
<p>To build a docker image and start the docker image.</p>
<div class="fragment"><div class="line">docker build --tag sipmcalib_control --platform linux/amd64 --rm ./</div>
<div class="line">docker run -it -p 9100:9100 sipmcalib_control:latest</div>
</div><!-- fragment --><p>This should start an interactive bash session, where once can then start the CLI/GUI interfaces with the python commands</p>
<div class="fragment"><div class="line">python control.py</div>
<div class="line">python gui_control.py</div>
</div><!-- fragment --><p>Notice that the files in the docker session are a copy and not a mount, meaning that if you should edit the file outside the docker session and rebuild the docker session to allow for data to be passed to docker session. If you did not modify the C++ files, you should not need to recompile.</p>
<h2>Installing software and firmware for the tileboard controller</h2>
<p>The second-largest components of the calibration system is the interface with the tileboard controller, used to communicate with the HGCAL systems. The requirements here are maintained by the broader HGCAL community, mainly by the University of Minnesota. With most of the instructions found for their <a href="https://readthedocs.web.cern.ch/display/HGCELE/Tileboard+Tester+V2+Quick+Start+Guide">read-the-docs page</a>.</p>
<p>To avoid out-of-date information, we will not be including software installation instructions here, but rather the administrators will be responsible for ensuring the software and firmware on the tileboard controller is up-to-date. The 3 key pieces of software that is required for the main calibration control sequence to work would include:</p>
<ul>
<li>The fast controls interaction server (usually named <code>zmq-server</code>)</li>
<li>The fast data pulling "client" (usually named the <code>zmq-client</code>)</li>
<li>The slow controls and readout server (usually named the <code>zmq_server</code>, notice the difference in hyphenation).</li>
</ul>
<p>Turn-key solutions for starting/stopping the tileboard control software programs are kept in the <code>scripts/tbcontroller</code> directory.</p>
<h2>Contributing to the code</h2>
<p>The main code base is hosted at this <a href="https://github.com/UMDCMS/SiPMCalibControl">GitHub repository</a>. Contact the developers for the pull request if you have something you want to add into the code base!</p>
<h3>Code organization</h3>
<p>Documentations for control software development can be found in their various directories:</p>
<ul>
<li>Documentation of the Hardware interfaces and other minimal dependency helper objects/functions can be found <a class="el" href="group__hardware.html">here</a>. The <code>src</code> directory contains the C++ implemented classes, and the <code>cmod</code> directory contains the python objects along with the python bindings for the C++ classes.</li>
<li>Documentation of the CLI interface can be found <a class="el" href="group__cli__design.html">here</a>. Files for this is typically found in the <code>ctlcmd</code> directory.</li>
<li>Documentation of the GUI interface can be found <a class="el" href="group__gui__design.html">here</a>. Files for this is typically found in the <code>server</code> directory:<ul>
<li>The server side code is found in the <code>server/sockets</code> directory.</li>
<li>The client side code is found in the <code>server/static/js</code> directory.</li>
<li>Styling file will likely not get their own documentation. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
<hr class="footer"/>
  <address class="footer">
    <small>
    Generated by <a href="http://www.doxygen.org/index.html">doxygen</a> 1.9.7
    </small>
  </address>
  <address class="footer">
    <small>
    Source code hosted on<a href="http://github.com">GitHub</a>
    </small>
  </address>
  <address class="footer">
    <small id="debugger">
    Debug:
    </small>
  </address>
<!-- custom Javascript stuff -->
  <script type="text/javascript" src="customjs/summary.js"></script>
</body>
</html>
