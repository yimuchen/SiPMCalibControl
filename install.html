<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SiPM Calibration Control Program: Installation instructions</title>
<!-- Overriding the tabs css with our own -->
<!--link href="tabs.css" rel="stylesheet" type="text/css"/-->
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--Explicitly calling the including the stuff required for search-->
<!--<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
-->
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" />
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SiPM Calibration Control Program
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Installation instructions</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Deploying the Calibration Control programs</h2>
<p>The dependencies required to compile and run the program is handled by <a href="https://docs.docker.com/">docker</a> with the <code>Dockerfile</code> found at the root directory of the project. This ensures that all deployments will run under the same set of packages to avoid setup specific issues from entering production.</p>
<p>Additional device permission setup is still required for the various data collection and control interface. The current configuration is designed to work on a <a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b-plus/">Raspberry Pi 3B+</a> running a <a href="https://archlinuxarm.org/about/downloads">ArchLinux ARMv8</a> host, though any Linux-based ARMv8 system should work, as long as one can set up system permissions and can install an up-to-date version of docker.</p>
<p>First, we clone the code repository:</p>
<div class="fragment"><div class="line">git clone https://github.com/UMDCMS/SiPMCalibControl.git</div>
<div class="line">cd SiPMCalibControl</div>
</div><!-- fragment --><h3>Setting up system permissions</h3>
<p>Modify the <code>/boot/config.txt</code> file so that PWM and I2C interfaces are available: add the following lines to the <em>after</em> the kernel loading line:</p>
<div class="fragment"><div class="line">dtoverlay=pwm-2chan</div>
<div class="line">dtparam=i2c_arm=on</div>
</div><!-- fragment --><p>Next, we create new permission groups to avoid running the master program as root. If you are testing this program on your personal machine, do <b>not</b> add yourself to the <code>gpio</code> and <code>i2c</code> groups, as these devices are typically reserved for temperature monitor and control system on typical computer laptop. Randomly changing <code>i2c</code> and <code>gpio</code> value <b>will</b> damage your device.</p>
<div class="fragment"><div class="line">groupadd -f -r pico</div>
<div class="line">usermod -a -G pico ${USER}</div>
<div class="line">groupadd -f -r drs</div>
<div class="line">usermod -a -G drs ${USER}</div>
<div class="line">## DO NOT ADD!! unless you are sure of what you are doing!</div>
<div class="line"># groupadd -f -r gpio</div>
<div class="line"># usermod -a -G gpio ${USER}</div>
<div class="line"># groupadd -f -r i2c</div>
<div class="line"># usermod -a -G i2c ${USER}</div>
</div><!-- fragment --><p>Then, copy the custom <code>udev</code> rules to expose device IDs to the various groups.</p>
<div class="fragment"><div class="line">cp external/rules/pico.rules  /etc/udev/rules/</div>
<div class="line">cp external/rules/drs.rules   /etc/udev/rules/</div>
<div class="line">## DO NOT ADD unless you are sure of what you are doing!!</div>
<div class="line"># cp external/rules/digi.rules  /etc/udev/rules/</div>
</div><!-- fragment --><p>Reboot the Raspberry Pi board to have everything take effect.</p>
<h3>Installing software and firmware for the tileboard controller</h3>
<p>The tileboard controller used to communicate with the HGCAL systems run on a standalone ELM machine running a full operating system. The UMD control system communicates with this system over Ethernet, assuming that the various services on the tileboard system is operating nominally. Requirements for the tileboard controller are maintained by the broader HGCAL community, mainly by the University of Minnesota. With most of the instructions found for their <a href="https://readthedocs.web.cern.ch/display/HGCELE/Tileboard+Tester+V2+Quick+Start+Guide">read-the-docs page</a>.</p>
<p>To avoid out-of-date information, we will not be including software installation instructions here, but rather the administrators will be responsible for ensuring the software and firmware on the tileboard controller is up-to-date. The 3 key pieces of software that is required for the main calibration control sequence to work would include:</p>
<ul>
<li>The fast controls interaction server (usually named <code>zmq-server</code>)</li>
<li>The fast data pulling "client" (usually named the <code>zmq-client</code>)</li>
<li>The slow controls and readout server (usually named the <code>zmq_server</code>, notice the difference in hyphenation).</li>
</ul>
<p>Turn-key solutions for starting/stopping the tileboard control software programs are kept in the <code>scripts/tbcontroller</code> directory.</p>
<h3>Deploying the docker image</h3>
<p>After permissions have been set. Navigate back to the code repository, then build and run the docker image:</p>
<div class="fragment"><div class="line">DEVICES=1 ./deploy.sh</div>
</div><!-- fragment --><p>The <code>DEVICES</code> flag is used to expose all device interfaces to the underlying docker image. Do <b>not</b> include this flag unless you know what you are doing. The first run of this program would be slow as it is generating the docker image. Subsequent runs should only upload changes made by the user and recompile the repository code if needed. For the initial setup from a clean install, the docker image generating is expected to take about 40-50 minutes to fully complete. Once the program is complete, you should be greeted with a bash prompt, where you can execute the main program:</p>
<div class="fragment"><div class="line">python3 control.py     # For starting interactive CLI</div>
<div class="line">python3 gui_control.py # For starting GUI server</div>
</div><!-- fragment --><p>The bash session is kept for the sake of debugging the deployment environment. If you know you want to start up straight into the CLI or the GUI, you can run the <code>./deploy.sh</code> like:</p>
<div class="fragment"><div class="line">./deploy.sh python3 control.py     # For directly starting the interactive CLI</div>
<div class="line"># ./deploy.sh python3 gui_control.py # TODO: currently fails to exit nominally</div>
</div><!-- fragment --><p>You will automatically exit the docker image one you terminate the CLI/GUI session.</p>
<h2>Deployment for software testing</h2>
<p>Installation instructions above should works for all UNIX like system assuming you can set up the various system permissions. If you are uncertain which permissions you can safely set up on the local machine, the program should still be run-able without any special permissions (but you will not be able to use any of the interface).</p>
<p>To build a docker image and start the docker image.</p>
<div class="fragment"><div class="line"># For mocking a x86 system</div>
<div class="line">PLATFORM=linux/amd64 ./deploy.sh</div>
<div class="line"> </div>
<div class="line"># For mocking a aarch64 system</div>
<div class="line">PLATFORM=linux/arm64 ./deploy.sh</div>
</div><!-- fragment --><p>For testing if the new code can run without issues on the target ARM platform (RPi3), you will potentially need the <a href="https://docs.docker.com/build/building/multi-platform/"><code>docker-buildx</code>+<code>qemu-user-static</code></a> package combination installed for the image builder to work. Beware the cross-platform execution can have significant performance penalties, in particular for code compilation. Also notice that device interfaces is not guaranteed to work through cross-platform docker images (not even the USB based devices). The construction of the docker image on a local laptop will take about 40-50 minutes from a clean installation on a Raspberry Pi.</p>
<p>Between testing different image types, you will need to clear the <code>cmake</code> cache files and compiled binary:</p>
<div class="fragment"><div class="line">./clean.sh</div>
</div><!-- fragment --><p>Using the provided <code>deploy.sh</code> script, the repository directory is mounted to the docker image, so edits made outside the docker image will also be reflected inside the docker image. While this does mean you can install dependencies on the fly in the docker image session, such installation will not be persistent. If you are certain that you need a new package. Consider modifying the Dockerfile or change the dependency listing files, then restart the <code>deploy</code> script.</p>
<h2>Contributing to the code</h2>
<p>The main code base is hosted at this <a href="https://github.com/UMDCMS/SiPMCalibControl">GitHub repository</a>. Contact the developers for the pull request if you have something you want to add into the code base!</p>
<h3>Code organization</h3>
<p>Documentations for control software development can be found in their various directories:</p>
<ul>
<li>Documentation of the Hardware interfaces and other minimal dependency helper objects/functions can be found <a class="el" href="group__hardware.html">here</a>. The <code>src</code> directory contains the C++ implemented classes, and the <code>cmod</code> directory contains the python objects along with the python bindings for the C++ classes.</li>
<li>Documentation of the CLI interface can be found <a class="el" href="group__cli__design.html">here</a>. Files for this is typically found in the <code>ctlcmd</code> directory.</li>
<li>Documentation of the GUI interface can be found <a class="el" href="group__gui__design.html">here</a>. Files for this is typically found in the <code>server</code> directory:<ul>
<li>The server side code is found in the <code>server/sockets</code> directory.</li>
<li>The client side code is found in the <code>server/static/js</code> directory.</li>
<li>Styling file will likely not get their own documentation. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
<hr class="footer"/>
  <address class="footer">
    <small>
    Generated by <a href="http://www.doxygen.org/index.html">doxygen</a> 1.9.7
    </small>
  </address>
  <address class="footer">
    <small>
    Source code hosted on<a href="http://github.com">GitHub</a>
    </small>
  </address>
  <address class="footer">
    <small id="debugger">
    Debug:
    </small>
  </address>
<!-- custom Javascript stuff -->
  <script type="text/javascript" src="customjs/summary.js"></script>
</body>
</html>
